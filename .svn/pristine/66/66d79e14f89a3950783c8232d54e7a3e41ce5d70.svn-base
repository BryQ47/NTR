using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Data.Entity.Infrastructure;
using System.Linq;
using System.Net;
using System.Net.Http;
using System.Web.Http;
using System.Web.Http.Description;
using StudentsListJS.Models;

namespace StudentsListJS.Controllers
{
    public class GroupsController : ExtendedApiController
    {
        private IHttpActionResult DefaultResponse(string exMsg = null)
        {
            try
            {
                var groups = from g in storage.GetGroups()
                             select new GroupDTO
                             {
                                 IDGroup = g.IDGroup,
                                 Name = g.Name,
                                 Stamp = g.Stamp
                             };

                return Json(new Response { students = null, groups = groups.ToArray(), error = exMsg });
            }
            catch (Exception ex)
            {
                return ErrorResponse("Nie można załadować listy grup. " + ex.Message, HttpStatusCode.InternalServerError);
            }
        }


        // GET: api/Groups
        public IHttpActionResult Get()
        {
            return DefaultResponse();
        }

        // PUT: api/Groups
        public IHttpActionResult Put(Group group)
        {
            string msg = null;
            try
            {
                storage.UpdateGroup(group);
            }
            catch (DBConcurrencyException cex)
            {
                msg = "Grupa została zmodyfikowana! " + cex.Message;
            }
            catch (Exception ex)
            {
                msg = ex.Message;
            }
            return DefaultResponse(msg);
        }

        // POST: api/Groups
        public IHttpActionResult Post(Group group)
        {
            string msg = null;
            try
            {
                storage.AddGroup(group);
            }
            catch (Exception ex)
            {
                msg = ex.Message;
            }
            return DefaultResponse(msg);
        }

        // DELETE: api/Groups
        public IHttpActionResult Delete(Group group)
        {
            string msg = null;
            try
            {
                storage.DeleteGroup(group);
            }
            catch (Exception ex)
            {
                msg = ex.Message;
            }
            return DefaultResponse(msg);
        }
    }
}