app.controller("studentsCtrl", ['$scope', '$http', 'ngTableParams',
    function ($scope, $http, NgTableParams) {

        var self = this;

        $scope.studentsTable = new NgTableParams();


        /******* Scope variables *******/

        $scope.students = [];
        $scope.groups = [];
        $scope.groupNames = [];
        $scope.showError = false;
        $scope.errorMsg = "";
        $scope.selectedStudent = {};

        /******* Scope functions *******/

        $scope.dismissError = HideErrorMsg;

        $scope.selectStudent = function (id) {
            var students = $scope.students;
            var nstud = students.length;
            for (var i = 0; i < nstud; ++i) {
                var stud = students[i];
                if (stud.IDStudent === id) {
                    var s = {};
                    s.BirthDate = stud.BirthDate;
                    s.BirthPlace = stud.BirthPlace,
                    s.FirstName = stud.FirstName,
                    s.IDGroup = stud.IDGroup,
                    s.IDStudent = stud.IDStudent,
                    s.IndexNo = stud.IndexNo,
                    s.LastName = stud.LastName,
                    //s.GroupName = s.Group.Name,
                    s.Stamp = stud.Stamp
                    $scope.selectedStudent = s;
                }
            }
        }

        /******* Private variables *******/

        

        /******* Initialization *******/

        getStudents();

        //$scope.applyFilter = changeFilter;



        /******* Private functions *******/

        //function changeFilter(field, value) {
        //    var filter = {};
        //    filter[field] = value;
        //    angular.extend($scope.tableParams.filter(), filter);
        //}

        function HideErrorMsg() {
            $scope.showError = false;
            $scope.errorMsg = "";
        }


        function loadStudents(newStudents, newGroups) {

            $scope.students = newStudents;
            $scope.groups = newGroups;

            ngroup = newGroups.length;

            var gnames = [];
            for (var k = 0; k < ngroup; ++k)
                gnames.push(newGroups[k].Name);

            $scope.groupNames = gnames;

            $scope.studentsTable.settings({
                dataset: newStudents
            });

        }

        function getStudents() {

            $http({
                method: 'GET',
                url: '/api/Students'
            }).then(function successCallback(response) {
                loadStudents(response.data.students, response.data.groups);
                if (response.data.error) {
                    $scope.errorMsg = response.data.error;
                    $scope.showError = true;
                }
            }, function errorCallback(response) {
                $scope.errorMsg = "Błąd serwera";
                $scope.showError = true;
            });


        }



        function putStudent() {

            var newStudent = { IDGroup: 1, FirstName: "Leszek", LastName: "Bogucki", IndexNo: "48903204" };

            $http({
                method: 'DELETE',
                url: '/api/Students/32',
                data: JSON.stringify({id: 31})
            }).then(function successCallback(response) {
                // this callback will be called asynchronously
                // when the response is available
                $scope.data = response;
            }, function errorCallback(response) {
                // called asynchronously if an error occurs
                // or server returns response with an error status.
                $scope.data = response;
            });

        }


}]);